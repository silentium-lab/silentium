var silentium=function(t){"use strict";const e=t=>null!=t;function n(t){return null!==t&&"object"==typeof t&&"then"in t&&"function"==typeof t.then}function r(t){return null!==t&&"object"==typeof t&&"use"in t&&"function"==typeof t.use}function s(t){return null!==t&&"object"==typeof t&&"destroy"in t&&"function"==typeof t.destroy}function i(t){return new c(t)}class c{constructor(t){this.base=t}destroy(){return s(this.base)&&this.base.destroy(),"function"==typeof this.base&&this.base(),this}}var o=Object.defineProperty,u=(t,e,n)=>((t,e,n)=>e in t?o(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n)(t,e+"",n);function h(){return new a}class a{constructor(){u(this,"destructors",[])}add(t){return this.destructors.push(i(t)),t}many(t){return t.forEach((t=>{this.add(t)})),this}destroy(){return this.destructors.forEach((t=>t.destroy())),this.destructors.length=0,this}destructor(){return this.destroy.bind(this)}}var l=Object.defineProperty,f=(t,e,n)=>((t,e,n)=>e in t?l(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n)(t,"symbol"!=typeof e?e+"":e,n);class d{constructor(){f(this,"catchers",[]),f(this,"lastRejectReason",null),f(this,"reject",(t=>{this.lastRejectReason=t,this.catchers.forEach((e=>{e(t)}))}))}catch(t){return null!==this.lastRejectReason&&t(this.lastRejectReason),this.catchers.push(t),this}destroy(){return this.catchers.length=0,this}}const y=Symbol("reset-silence-cache");function b(t){let n;return r=>{r===y&&(n=void 0,r=void 0),e(r)&&r!==n&&(n=r,t(r))}}function p(t,e){if("function"!=typeof t)throw new Error(`${e}: is not function`)}var m=Object.defineProperty,v=(t,e,n)=>((t,e,n)=>e in t?m(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n)(t,"symbol"!=typeof e?e+"":e,n);function w(t){return new g(t)}class g{constructor(t){this.executor=t,v(this,"rejections",new d),v(this,"dc",h()),p(t,"Message: executor")}then(t){try{this.dc.add(this.executor(b(t),this.rejections.reject))}catch(t){this.rejections.reject(t)}return this}catch(t){return this.rejections.catch(t),this}destroy(){return this.dc.destroy(),this.rejections.destroy(),this}}function j(t){return w((function(e){e(t)}))}function E(t){return n(t)?t:j(t)}class R{constructor(t){this.src=t}chain(t){return t.then(this.src.use.bind(this.src)),this}}var S=Object.defineProperty,$=(t,e,n)=>((t,e,n)=>e in t?S(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n)(t,e+"",n);class C{constructor(t,e){this.sourceExecutor=e,$(this,"message"),this.message=w(t)}use(t){return this.sourceExecutor(t),this}then(t){return this.message.then(t),this}catch(t){return this.message.catch(t),this}}function P(){return()=>{}}function x(...t){const e=t.map(E);return w((function(n,r){const s=new Set(Object.keys(t)),i=new Set,c=[];0!==s.size?e.map(((t,e)=>{t.catch(r),t.then((t=>{var r,o;i.add(e.toString()),c[e]=t,o=s,(r=i).size>0&&r.size===o.size&&n(c.slice())}))})):n([])}))}function D(t,e){const n=E(t);return w((function(t,r){n.catch(r),n.then((n=>{t(e(n))}))}))}function O(t,e){return D(t,(function(t){return e(...t)}))}var M=Object.defineProperty,V=(t,e,n)=>((t,e,n)=>e in t?M(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n)(t,e+"",n);function I(t,e=null){return new T(t,e)}class T{constructor(t,e=null){this.$base=t,this.theValue=e,V(this,"touched",!1)}ensureTouched(){this.touched||this.$base.then((t=>{this.theValue=t})),this.touched=!0}[Symbol.toPrimitive](){return this.ensureTouched(),this.theValue}primitive(){return this.ensureTouched(),this.theValue}primitiveWithException(){if(this.ensureTouched(),null===this.theValue)throw new Error("Primitive value is null");return this.theValue}}var z=Object.defineProperty,A=(t,e,n)=>((t,e,n)=>e in t?z(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n)(t,"symbol"!=typeof e?e+"":e,n);function k(t){return new F(t)}class F{constructor(t){this.$base=t,A(this,"resolver",(t=>{this.lastV=t,this.resolvers.forEach((e=>{e(t)}))})),A(this,"lastV"),A(this,"resolvers",new Set),A(this,"source"),r(t)&&(this.source=t)}then(t){return this.resolvers.add(t),1===this.resolvers.size?this.$base.then(this.resolver):e(this.lastV)&&t(this.lastV),this}use(t){return this.source?this.source.use(t):this.resolver(t),this}catch(t){return this.$base.catch(t),this}destroy(){return this.resolvers.clear(),s(this.$base)&&this.$base.destroy(),this}value(){return I(this)}chain(t){return t.then(this.use.bind(this)),this}}var L=Object.defineProperty,N=(t,e,n)=>((t,e,n)=>e in t?L(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n)(t,"symbol"!=typeof e?e+"":e,n);function W(t){return k(new q(t))}class q{constructor(t){this.v=t,N(this,"rejections",new d),N(this,"lateR",null),N(this,"notify",(()=>{if(e(this.v)&&this.lateR)try{this.lateR(this.v)}catch(t){this.rejections.reject(t)}}))}then(t){if(this.lateR)throw new Error("Late component gets new resolver, when another was already connected!");return this.lateR=b(t),this.notify(),this}use(t){return this.v=t,this.notify(),this}catch(t){return this.rejections.catch(t),this}}function J(t,e={}){const n=O(x(E(t),E(e)),((t,e)=>({transport:t,params:e,result:void 0,error:void 0})));return w(((t,e)=>{n.then((n=>{const r=J.transport.get(n.transport);if(void 0===r)throw new Error(`Context: unknown transport ${n.transport}`);n.result||(n.result=t),n.error||(n.error=e);try{r(n)}catch(t){e(t)}}))}))}function B(t,e,n){const r=E(t);return w((function(t,s){r.catch(s),r.then((r=>{e(r)?t(r):void 0!==n&&t(n)}))}))}J.transport=new Map;var G=Object.defineProperty,H=(t,e,n)=>((t,e,n)=>e in t?G(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n)(t,e+"",n);const K=Symbol("nothing");class Q{constructor(t){this.$base=t,H(this,"$empty",W())}message(){return k(this.$base).then((t=>{t===K&&this.$empty.use(!0)})),B(this.$base,(t=>t!==K))}empty(){return this.$empty}}const U=(...t)=>{D(x(...t.map((t=>k(t)))),JSON.stringify).then(console.log)},X=t=>I(t).primitive();class Y{constructor(t){this.onDestroy=t}then(t){return t(`Wait destroy ${Date.now()}`),this}catch(){return this}destroy(){return this.onDestroy(),this}}const Z=t=>new Y(t);return t.ActualMessage=E,t.All=x,t.Any=function(...t){const e=t.map(E);return w((function(t,n){e.forEach((e=>{e.catch(n),e.then(t)}))}))},t.Applied=D,t.AppliedDestructured=O,t.Catch=function(t){const e=new d;t.catch(e.reject);const n=W();return e.catch((t=>{n.use(t)})),n},t.Chain=function(...t){const e=t.map(E);return w((function(t,n){let r;const s=i=>{const c=e[i];c.catch(n);const o=e[i+1];c.then((e=>{!function(e,n,i){n||(r=e);r&&t(r);n&&!r&&s(i+1)}(e,o,i)}))};s(0)}))},t.Chainable=function(t){return new R(t)},t.ChainableImpl=R,t.Computed=function(t,...e){return O(x(...e),t)},t.Connected=function(...t){const e=h();return e.many(t),w(((n,r)=>(t[0].catch(r).then(n),t.slice(1).forEach((t=>{t.catch(r)})),e.destructor())))},t.Context=J,t.ContextChain=function(t){const e=E(t);return t=>{if(!t.result)throw new Error("ContextChain did not find result field in message");e.then(t.result)}},t.ContextOf=function(t){const e=W();return J.transport.set(t,e.use.bind(e)),w(((t,n)=>{e.catch(n),e.then(t)}))},t.DestroyContainer=h,t.DestroyContainerImpl=a,t.Destroyable=i,t.DestroyableImpl=c,t.DevTools=function(){"undefined"!=typeof globalThis&&(globalThis.silentiumDebug={value:X,print:U,destroyable:Z})},t.Empty=function(t){return new Q(t)},t.EmptyImpl=Q,t.ExecutorApplied=function(t,e){return w((function(n,r){t.catch(r),t.then(e(n))}))},t.Filtered=B,t.Freeze=function(t,e){let n=null;return w((function(r,s){t.catch(s),t.then((t=>{null===n&&(n=t),r(n)})),e?.then((()=>{n=null}))}))},t.FromEvent=function(t,e,n,r){const s=E(t),i=E(e),c=E(n),o=E(r);return w(((t,e)=>{s.catch(e),i.catch(e),c.catch(e),o.catch(e);let n=null;const r=t=>{n&&n(t)};return x(s,i,c).then((([e,s,i])=>{n=t,e?.[i]&&e[i](s,r)})),()=>{n=null,o&&x(s,i,o).then((([t,e,n])=>{t?.[n]?.(e,r)}))}}))},t.Late=W,t.LateImpl=q,t.Local=function(t){const e=E(t);return w((function(t,n){let r=!1;return e.then((e=>{r||t(e)})),e.catch(n),()=>{r=!0}}))},t.Map=function(t,e){const r=E(t);return w(((t,s)=>{r.catch(s);const i=[],c=h();r.then((r=>{i.length=0,c.destroy(),r.forEach((t=>{let r=t;n(r)||(r=j(r));const s=e(r);c.add(s),i.push(s)})),x(...i).then(t)}))}))},t.Message=w,t.MessageDestroyable=Y,t.MessageImpl=g,t.MessageSource=function(t,e){return new C(t,e)},t.MessageSourceImpl=C,t.New=function(t){return w((function(e){e(t())}))},t.Nothing=K,t.Of=j,t.Once=function(t){return w(((e,n)=>{let r=!1;t.catch(n),t.then((t=>{r||(r=!0,e(t))}))}))},t.Piped=function(t,...e){return e.reduce(((t,e)=>E(e(t))),E(t))},t.Primitive=I,t.PrimitiveImpl=T,t.Process=function(t,e){return w(((n,r)=>{const s=W(),i=h();return t.then((t=>{i.destroy();const n=e(t);i.add(n),s.chain(n),n.catch(r)})),t.catch(r),s.then(n),()=>{i.destroy()}}))},t.Race=function(...t){const e=t.map(E);return w(((t,n)=>{let r=!1;e.forEach((e=>{e.catch(n).then((e=>{!1===r&&(r=!0,t(e))}))}))}))},t.Rejections=d,t.ResetSilenceCache=y,t.Sequence=function(t){return w(((e,n)=>{const r=[];t.catch(n),t.then((t=>{r.push(t),e(r.slice())}))}))},t.Shared=k,t.SharedImpl=F,t.Silence=b,t.Stream=function(t){const e=E(t);return w(((t,n)=>{e.catch(n),e.then((e=>{e.forEach((e=>{t(e)}))}))}))},t.Trackable=function(t,e){return J("trackable",{name:t,action:"created"}).then((()=>{})),new Proxy(e,{get:(e,n,r)=>("destroy"===n&&J("trackable",{name:t,action:"destroyed"}).then((()=>{})),Reflect.get(e,n,r))})},t.Void=P,t.ensureFunction=p,t.ensureMessage=function(t,e){if(!n(t))throw new Error(`${e}: is not message`)},t.isDestroyable=s,t.isDestroyed=function(t){return null!==t&&"object"==typeof t&&"destroyed"in t&&"function"==typeof t.destroyed},t.isFilled=e,t.isMessage=n,t.isSource=r,t}({});
